<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MRS</title>
</head>
<body>

    <h1>Material Requisition slip</h1>

    <!-- ✅ Item Entry Section -->
    <label for="searchBox">Item Name:</label>
    <input type="text" id="searchBox" placeholder="Search for an item">
    <div id="suggestions"></div>

    <!-- ✅ Auto-filled Item Code -->
    <label for="itemCode">Item Code:</label>
    <input type="text" id="itemCode" readonly>

    <!-- ✅ Area Dropdown -->
    <label for="area">Area:</label>
    <select id="area">
        <option value="PUMP HOUSE">PUMP HOUSE</option>
        <option value="RO PLANT">RO PLANT</option>
        <option value="GASZONE">GAS ZONE</option>
        <option value="FURNACE">FURNACE</option>
        <option value="MATERIAL HANDELING">MATERIAL HANDLING</option>
        <option value="ELECTRICAL">ELECTRICAL</option>
        <option value="OPERATION">OPERATION</option>
    </select>

    <!-- ✅ Date Picker -->
    <label for="date">Date:</label>
    <input type="date" id="date">

    <!-- ✅ Shift Dropdown -->
    <label for="shift">Shift:</label>
    <select id="shift">
        <option value="G">G</option>
        <option value="A">A</option>
        <option value="B">B</option>
        <option value="C">C</option>
    </select>

    <!-- ✅ Log Consumption Button -->
    <button onclick="logConsumption()">Log Consumption</button>

    <!-- ✅ Consumption History Table -->
    <h2>Consumption History</h2>
    <div id="consumptionHistory">
        <p>Loading consumption history...</p>
    </div>

    <script>
    window.onload = function() {
        let searchBox = document.getElementById("searchBox");
        let suggestionsBox = document.getElementById("suggestions");

        if (searchBox) {
            searchBox.addEventListener("input", function() {
                let query = this.value;
                if (query.length < 1) {
                    suggestionsBox.innerHTML = "";
                    return;
                }

                fetch("/get-items")
                    .then(response => response.json())
                    .then(items => {
                        let matches = items.filter(item => 
                            item["Item Name"].toLowerCase().includes(query.toLowerCase())
                        );

                        suggestionsBox.innerHTML = matches
                            .map(item => `<p class="suggestion-item" onclick="selectItem('${item["Item Name"]}', '${item["Item Code"]}')">${item["Item Name"]} (${item["Item Code"]})</p>`)
                            .join("");
                    })
                    .catch(error => console.error("❌ Error fetching items:", error));
            });
        }

        function selectItem(itemName, itemCode) {
            document.getElementById("searchBox").value = itemName;
            document.getElementById("itemCode").value = itemCode;
            document.getElementById("suggestions").innerHTML = "";
        }

        function logConsumption() {
            let itemName = document.getElementById("searchBox").value.trim();
            let itemCode = document.getElementById("itemCode").value.trim();
            let area = document.getElementById("area").value;
            let date = document.getElementById("date").value;
            let shift = document.getElementById("shift").value;

            if (!itemName || !itemCode || !area || !date || !shift) {
                alert("❌ Please fill all fields before logging consumption.");
                return;
            }

            let consumptionData = {
                "Item name": itemName,
                "Item code": itemCode,
                "Consumed Area": area,
                "Date": date,
                "Shift": shift,
                "QTY": 1
            };

            fetch("/log-consumption", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(consumptionData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("✅ Consumption logged successfully!");
                    loadConsumptionHistory();
                } else {
                    alert("❌ Error logging consumption: " + data.error);
                }
            })
            .catch(error => console.error("❌ Error logging consumption:", error));
        }

        function loadConsumptionHistory() {
            fetch("/consumption-history")
                .then(response => response.json())
                .then(data => {
                    let historyTable = "<table border='1'><tr><th>Item Name</th><th>Item Code</th><th>QTY</th><th>Consumed Area</th><th>Date</th><th>Shift</th></tr>";
                    data.forEach(entry => {
                        historyTable += `<tr>
                            <td>${entry["Item name"]}</td>
                            <td>${entry["Item code"]}</td>
                            <td>${entry["QTY"]}</td>
                            <td>${entry["Consumed Area"]}</td>
                            <td>${entry["Date"]}</td>
                            <td>${entry["Shift"]}</td>
                        </tr>`;
                    });
                    historyTable += "</table>";
                    document.getElementById("consumptionHistory").innerHTML = historyTable;
                })
                .catch(error => console.error("❌ Error fetching consumption history:", error));
        }

        loadConsumptionHistory();
    };
</script>


</body>
</html>
