<script>
    window.onload = function() {
        // ✅ Ensure searchBox exists before adding event listener
        let searchBox = document.getElementById("searchBox");
        
        if (searchBox) {
            searchBox.addEventListener("input", function() {
                let query = this.value;
                if (query.length < 1) {
                    document.getElementById("suggestions").innerHTML = "";
                    return;
                }

                fetch("/get-items")
                    .then(response => response.json())
                    .then(items => {
                        let matches = items.filter(item => 
                            item["Item Name"].toLowerCase().includes(query.toLowerCase())
                        );

                        document.getElementById("suggestions").innerHTML = matches
                            .map(item => `<p onclick="selectItem('${item["Item Name"]}', '${item["Item Code"]}')">${item["Item Name"]} (${item["Item Code"]})</p>`)
                            .join("");
                    })
                    .catch(error => console.error("❌ Error fetching items:", error));
            });
        } else {
            console.error("❌ Error: searchBox element not found in HTML.");
        }

        // ✅ Ensure filters exist before loading consumption history
        let filterArea = document.getElementById("filterArea");
        let filterDate = document.getElementById("filterDate");

        function loadConsumptionHistory() {
            let area = filterArea ? filterArea.value : "";
            let date = filterDate ? filterDate.value : "";
            
            let url = "/consumption-history";
            let params = [];

            if (area) params.push(`area=${encodeURIComponent(area)}`);
            if (date) params.push(`date=${encodeURIComponent(date)}`);

            if (params.length > 0) {
                url += "?" + params.join("&");
            }

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    let historyTable = "<table border='1'><tr><th>Item Name</th><th>Item Code</th><th>QTY</th><th>Consumed Area</th><th>Date</th><th>Shift</th></tr>";
                    data.forEach(entry => {
                        historyTable += `<tr>
                            <td>${entry["Item name"]}</td>
                            <td>${entry["Item code"]}</td>
                            <td>${entry["QTY"]}</td>
                            <td>${entry["Consumed Area"]}</td>
                            <td>${entry["Date"]}</td>
                            <td>${entry["Shift"]}</td>
                        </tr>`;
                    });
                    historyTable += "</table>";
                    document.getElementById("consumptionHistory").innerHTML = historyTable;
                })
                .catch(error => console.error("❌ Error fetching consumption history:", error));
        }

        // ✅ Load history on page load if elements exist
        if (document.getElementById("consumptionHistory")) {
            loadConsumptionHistory();
        } else {
            console.error("❌ Error: consumptionHistory element not found in HTML.");
        }
    };

    function selectItem(itemName, itemCode) {
        document.getElementById("searchBox").value = itemName;
        document.getElementById("itemCode").value = itemCode;
        document.getElementById("suggestions").innerHTML = "";
    }
</script>
